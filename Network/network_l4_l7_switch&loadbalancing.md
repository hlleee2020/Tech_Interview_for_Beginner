# L4, L7 스위치 & 로드밸런싱


## ✅ 스위치란?

- 네트워크를 연결하는 일을 하는 목적을 가진 기기.
- 자신과 연결된 모든 기기에서 들어오는 패킷을 수신하고, 패킷을 적당한 기기로 보내는 일을 한다.
- OSI 7 계층에서 어느 계층까지 다루는지를 기준으로 스위치의 카테고리를 나눈다.
- L4, L7 스위치는 로드밸런싱을 수행한다.

## ✅ 로드밸런서란?

### 📌로드밸런싱이 왜 필요할까❓

> 
> 
> 
> 서버가 단 하나만 존재할 때 수천만명의 사람들이 서버에 동시 접속하면 하나의 서버는 부하를 감당하지 못할 수도 있을 것이다. 이를 해결하는 방식에는 장비를 업그레이드하는 **Scale-up**방식과 장비를 여러개 두는 **Scale-out**방식이 있다.
> 
> Scale-out 방식으로 여러 서버를 둔다면 해당 서비스에 접근하기 위해서는 서버마다 다른 IP가 필요하다. 서버마다 다른 공인 IP를 부여한다면 사용자들마다 각각 다른 IP로 접속할 것이고, 운영자가 원하는대로 딱! 떨어지게 부하를 분산하기 어렵다. 1000명의 사용자가 있을때 서버 2대에 500명 : 500명 접속하지 않고, 999명은 A서버에, 1명은 B서버에 접속한다면, 고가의 비용을 들여 새로운 서버를 증설한 것이 헛수고이다.
> 
> 이런 상황을 방지하기 위해 서버에 가해지는 트래픽의 부하를 분산하는 작업이 필요하다. 이렇게 두개이상의 컴퓨터자원에 작업을 나누는것을 로드밸런싱이라고 하고, 이런 작업을 하는 장비를 로드밸런서라고 한다.
> 

### 📌로드밸런서의 종류

|||
| --- | --- |
| L2 | Data link 계층을 사용, Mac주소 기반 부하 분산 |
| L3 | Network 계층을 사용, IP주소 기반 부하 분산 |
| L4 | Transport 계층을 사용, Port 기반 부하 분산 |
| L7 | Application 계층을 사용, 요청(URL) 기반 부하 분산 |
|||

- 로드밸런서의 종류를 나누는 기준은 OSI 7계층을 기준으로 어떻게 부하를 분산하는지에 따라 종류가 나뉜다.
- 2계층을 기준으로 부하를 분산한다면 L2 로드밸런서, L2, L3 계층을 기준으로 부하를 분산한다면 L3장비.
- 상위 계층으로 갈수록 섬세한 부하 분산이 가능하지만 가격이 비싸진다.

### 📌**로드밸런서의 주요 기능**

1. ***Network Address Translation(NAT)***
    
    사설 IP를 공인 IP로 바꾼다.
    
2. ***Tunneling***
    
    데이터를 캡슐화하여 연결되어진 노드만 그 데이터의 캡슐을 풀어서 볼수있게 해준다.
    
3. ***Dynamic Source Routing protocol(DSR)***
    
    요청에 대한 응답을 할 때 로드밸런서가 아닌 클라이언트의 IP로 응답한다.
    

### 📌요약 및 + α

- **로드밸런서**는 트래픽을 받아서 **여러 대의 서버에 분산**시키는 하드웨어 또는 소프트웨어.
- 부하 분산에는 L4 Load Balancer와 L7 Load Balancer가 많이 사용된다. (L4부터 Port를 다룰 수 있기 때문)
- 한 대의 서버의 각각의 포트에 여러개의 서비스들을 운영하기 위해서 L4 Layer 위에서 작동하는 Load Balancer가 필요해진 것.
- 이전에는 L4 하드웨어 장비를 주로 사용했지만, 현재는 MSA의 등장 등으로 L7 로드밸런싱도 많이 사용하고, AWS ELB, NginX, HaProxy등 다양한 소프트웨어를 사용하고 있다.

### 📌 로드밸런싱 의 종류

1. Round Robin

- 요청이 들어오는대로 서버마다 균등하게 요청을 분배하는 알고리즘.
- server를 순회하면서 서비스하는 알고리즘.
- a,b,c 서버가 있으면 a,b,c,a 순으로 돌면서 부하를 분산하는 방식.
- 가장 간단하고 이해가 쉬워서 많이 사용하지만 서버간 처리 용량이 다른 경우에는 적합하지 않아서 서버의 성능차이가 크지 않을 때 많이 사용됨.

2.  Weighted Round Robin

- 라운드 로빈방식과 유사하지만 각 서버마다 가중치를 두어 우선적으로 갈 곳을 지정한다.
- 서버 가중치는 사용자가 지정할 수 도 있고 동적으로 조정되기도 합니다.

3. Least Connection
- 최소연결 알고리즘은 서버마다 연결된 커넥션이 몇개인지 체크하여 커넥션이 가장 적은 서버로 요청을 분배하는 방식

4. Weighted Least Connecion

- 리스트 커넥션방식으로 분배하지만 서버 가중치에 따라 요청을 더 분배하기도 하고 덜 분배하기도 한다. 서버 풀에 존재하는 서버들의 사양이 일관적이지 않고 다양한 경우 효과적이다.

5. Fatest Response Time
- 응답우선방식은 서버가 요청에 대해 응답하는 시간을 체크하여 가장 빠른 서버로 요청을 분배하는 방식

6. source Hash

- 사용자의 IP를 해싱한 후 그 결과에 따라 서버로 요청을 분배하는 방식으로 사용자의 IP는 고정되어 있기 때문에 항상 같은 서버로 연결된다는 보장을 받을 수 있다.

## ✅ L4 Load Balancer


- 4계층 - 네트워크 계층 (IP, IPX)이나 3계층 - 전송계층(TCP, UDP)의 정보를 바탕으로 로드를 분산한다.
- 즉, IP 주소, 포트번호, MAC주소, 전송 프로토콜 등에 따라 트래픽을 분산하는 것이 가능.
- 클라이언트에서 로드밸런서(DNS)로 요청을 보냈을 때 최적의 서버로 요청을 전송하고 결과를 클라이언트에게 준다. 즉, 요청하는 서비스의 종류와 상관 없이 공장을 여러 개 돌리는 것.

**장점**

- 패킷의 내용을 확인하지 않고 로드를 분산하므로 **속도가 빠르고 효율이 높음.**
- 데이터의 내용을 **복호화할 필요가 없기에** 안전.
- L7 로드밸런서보다 **가격이 저렴.**

**단점**

- 패킷의 내용을 살펴볼 수 없으므로, **섬세한 라우팅 불가.**
- **사용자의 IP가 수시로 바뀌는 경우**라면, 연속적인 서비스를 제공하기 어려움.

## ✅ L7 Load Balancer

- **L7 Load Balancer**는 L7 위에서 동작하기 때문에 IP, Port 이외에도 ***URI, Payload, Http Header, Cookie*** 등의 내용을 기준으로 부하를 분산한다. 그래서 콘텐츠 기반 스위칭이라고도 함.
- L4 Load Balancer는 단지 부하를 분산시키는 것이라면, L7 Load Balancer는 요청의 세부적인 사항을 두고 결제만 담당하는 서버, 회원가입만을 담당하는 서버 등으로 분리해서 가볍고 작은 단위로 여러 개의 서비스를 운영하고 요청을 각각의 서버에 분산할 수 있는 것이다.
- L7 Load Balancer는 L4 Load Balancer와 다르게 데이터를 분석해서 처리가 가능하기 때문에 악의적이거나 비 정상적인 콘텐츠를 감지해 보안 지점을 구축할 수도 있는 장점이 있고, 그 만큼 자원 소모가 크다는 단점이 있다.



**장점**

- 상위 계층에서 로드를 분산하기 때문에 **훨씬 더 섬세한 라우팅** 가능. 
- **캐싱(Cashing) 기능** 을 제공. 
- 비정상적인 트래픽을 사전에 필터링할 수 있어 **서비스** 안정성 높음.

**단점**

- L4 로드밸런서에 비해 **비쌈.** 
- **패킷의 내용을 복호화하여야** 하므로 더 높은 비용을 지불해야 함. 
- 클라이언트가 로드밸런서와 인증서를 공유해야 하기 때문에, 공격자가 로드밸런서를 통해 클라이언트의 데이터에 접근할 수 있는 **보안상의 위험성** 존재.

## ✅ L4 vs L7
<img src="./img/network_l4_l7_switch&loadbalancing_1.png" height = "300px" alt = "network_basic_9 img">

### 공통점

- 들어온 packet을 적절한 목적지로 전달(스위치) 역할 수행.
- 적절한 알고리즘을 통해 로드밸런서로서의 역할을 수행.
- 스위치 및 서버별 Health Check를 통해, 이중화 구성후 장애시 Standby 상태의 기기는 장애스위치의 패킷을 넘겨와 active로 동작해 서버에 넘겨줌.

### 차이점

- L4는 로드밸런서에서 알고리즘을 통해 server1 또는 server2로 데이터를 전송할지 결정을 하고 Client와 3way handshake를 실시하여 하나의 TCP세션을 갖게 된다. (L/B는 중계역할을 함) 그 후 application 층에서 클라이언트의 요청정보(HTTP, FTP 등)를 전달받는다.
- L7는 L/B에서 콘텐츠 기반 스위칭을 위해 3way handshake를 보류한다. L/B와 client 간 3way handshake를 실시하여 따로 TCP 세션을 형성, L7과 server서버는 또 다른 TCP 세션을 형성하고 데이터를 중계한다.
- L7 패킷 분석을 통한 바이러스 감염 패킷 필터링이 가능하다.
- L7은 L4의 서비스 단위 로드밸런싱을 극복하기 위한 포트 + 페이로드 패턴을 이용하여 패킷스위칭을 한다.
- L4는 TCP/UDP 패킷 정보를 분석하고 해당 패킷이 사용하는 서비스 종류별(HTTP, FTP 등)로 처리하기 때문에 프록시 문제가 발생 될 수 있다.


## ✅ 출처
[L4 / L7 로드밸런서 차이 (Load balancer)](https://jaehoney.tistory.com/73)

[로드밸런서란?(L4, L7)](https://vaert.tistory.com/m/189)

[L4 로드밸런서 vs L7 로드밸런서](https://skstp35.tistory.com/m/324)